Okay, here is a revised bug report incorporating the deeper analysis and your specific observations.

***

## Bug Report: `Untap` Mana Calculation Ignores Board State, Uses Flawed Heuristics, and Has Display Errors

**ID:** MANA-006
**Priority:** Critical
**Status:** Open

### Summary

The `Untap & Generate Mana` function at the start of each turn is fundamentally flawed. It does not calculate mana based on the actual permanents on the battlefield. Instead, it appears to rely primarily on an incorrect `turn_number - 1` heuristic from Turn 4 onwards, completely ignores mana from artifacts, and suffers from a misleading display bug in the log text concerning the number of lands counted. While the intra-phase mana tracking (adding mana from `playLand`, subtracting from `castSpell`) appears correct, the incorrect starting mana provided by the `Untap` function invalidates the simulation's accuracy.

### Detailed Findings

1.  **Core Issue: `Untap` Function Ignores Actual Board State, Uses Heuristic:**
    * The function does not iterate through permanents on the battlefield to determine available mana.
    * From Turn 4 onwards, the reported starting mana consistently matches a `turn_number - 1` calculation, regardless of the actual mana sources present.
    * **T4:** Board should produce 4 mana (3 Lands + Talisman). Log reports 3 mana (`4 - 1`).
    * **T8:** Board should produce 8 mana (7 Lands + Talisman). Log reports 7 mana (`8 - 1`).
    * **T9:** Board should produce 9 mana (8 Lands + Talisman). Log reports 8 mana (`9 - 1`). (No land was played this turn).
    * **T10:** Board should produce 10 mana (8 Lands + 2 Talismans). Log reports 8 mana (Heuristic appears broken/capped here, possibly unrelated to the T9 missed land drop).

2.  **`Untap` Function Ignores Artifact Mana:**
    * Mana generated by artifacts (e.g., `Talisman of Dominance`) is consistently omitted from the starting mana calculation in the `Untap` step.
    * This directly violates the mana specification requiring all permanents' parsed abilities to be considered.

3.  **Unexplained Anomaly in T3 Calculation:**
    * The T3 calculation (`0 lands + 1 artifacts = 4 mana available`) does not match the heuristic (`3 - 1 = 2`) nor the actual board state (2 Lands + 1 Talisman = 3 mana). This suggests additional flawed or inconsistent logic is present.

4.  **Misleading Log Display Text for Land Count:**
    * The `"X lands"` text reported in the `Untap` step is bugged and does not reflect the actual number of lands on the battlefield.
    * It incorrectly reports `"0 lands"` until Turn 5, then switches to `"1 lands"` and remains there, possibly triggered incorrectly by `Drowned Catacomb`'s presence or another condition. This display error obscures the underlying calculation problems.

### Conclusion

The mana system's accuracy is critically compromised because the `Untap & Generate Mana` function fails to assess the actual board state. It relies on incorrect heuristics and ignores artifact mana sources. While the intra-phase logic now correctly handles mana changes *after* the `Untap` step, the simulation operates with an invalid starting mana total each turn.

### Recommendation

1.  **Rewrite `Untap & Generate Mana` Function:** This function **must** be entirely reworked to:
    * Iterate through *all* permanents currently on the `gameState.battlefield`.
    * For each permanent, retrieve its **parsed mana ability data** (as defined in the specification).
    * Correctly **sum the potential mana** based on these abilities, producing an accurate starting mana pool object (e.g., `{ W: 0, U: 3, B: 4, R: 0, G: 0, C: 1 }`).
    * **Completely remove** any turn-based heuristics or simple land/artifact counts from the calculation logic.
2.  **Fix Log Display:** Correct the logging in the `Untap` step to accurately display the number of lands being considered (or remove this potentially misleading metric).